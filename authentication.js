!function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=13)}([function(e,t,o){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(o(4));t.AppError=class{constructor(e,t,o,n,r,s){this.errorNameException=e,this.name=e,this.message=t,this.errorValues=o,this.errorCode=n,this.messageSystem=r,this.errorDate=new Date,this.userName=s,this.saveError()}saveError(){r.default.getDbMultitenant("common").collection("error").insertOne(this).then()}};t.ErrorValue=class{constructor(e,t){this.key=e,this.value=t}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.env={mongo:{url:"mongodb://localhost:27017",db:"dbMicap",common:"mongodb://localhost:27017/common",c0:"mongodb://localhost:27017/common",c1:"mongodb://localhost:27017/c1",c2:"mongodb://localhost:27017/c2",c3:"mongodb://localhost:27017/c3",c4:"mongodb://localhost:27017/c4",c5:"mongodb://localhost:27017/c5",c6:"mongodb://localhost:27017/c6",c7:"mongodb://localhost:27017/c7",c8:"mongodb://localhost:27017/c8",c9:"mongodb://localhost:27017/c9",c10:"mongodb://localhost:27017/c10"},mongoTest:{url:"mongodb://localhost:27017",db:"dbMicapTest"},port:{authentication:3e3,userManagement:3002,roleManagement:3002,functionManagement:3003,productoManagement:3004},privateKey:"clver princada con erroes",privateKeyToResetPaaword:"clver princada con erroes 2",privateKeyToConfimrEmail:"clver princada con erroes 2 me lo lloro",hostFront:"http://localhost:4200",oauth:{github:{clientId:"917d9ea48c6079361db7",secret:"95f840d74161b2031e5bc5ae030fdd6d9e4aa435"},google:{clientId:"169588101511-s41mv83ehmd7d1e18liaos8uqrl1v505.apps.googleusercontent.com",secret:"UKCbrNz-s7fByse9LLYb2ynI",redirect_uri:"http://localhost:3000/authentication/google"},facebook:{clientId:"972932186189099",secret:"3f5781eeb24a6eb56ea309539a7a9d84",redirect_uri:"http://localhost:3000/authentication/facebook"}},email:{user:"100505@unsaac.edu.pe",password:"alizonmelani123k",host:"smtp.gmail.com",server:"gmail"}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.errors={UserNotFoundError:{code:1e3,name:"ObjectNotFoundException",message:"El usuario con nombre $name no existe"},ValidateRequestError:{code:2e3,name:"ValidationException",message:"El objeto no cumple con los requisitos"},LoginError:{code:3e3,name:"AuthenticationException",message:"El usuario no coincide con la contraseÃ±a"},TokenExpirationError:{code:3010,name:"AuthenticationException",message:"El token ingresado expiro"},AuthorizationError:{code:3020,name:"AuthorizationException",message:"El usuario no tiene permiso para acceder a $1"},AuthenticationErrorGlobal:{code:3021,name:"AuthorizationException",message:""},ObjectNullError:{code:4e3,name:"ObjectNullError",message:"El objeto es nulo = "},HeaderError:{code:5e3,name:"HeaderError",message:"El header con el parametro : $1 no existe"},SystemError:{code:9e3,name:"SystemError",message:"El sistema presenta el siguiente error : "}}},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))(function(r,s){function i(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?r(e.value):new o(function(t){t(e.value)}).then(i,a)}c((n=n.apply(e,t||[])).next())})},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=r(o(20)),i=o(21),a=o(8),c=o(5);function u(e,t){const o={};for(const n in t)if(s.default.isArray(t[n])){if(!s.default.isArray(e[n]))throw i.ValidationError.ValidateObjectException(n);{const r=[];if(s.default.isFunction(t[n][0]))for(const o of e[n]){const e=t[n][0](o);if(!e)throw i.ValidationError.ValidateObjectException(n);r.push(e)}else for(const o of e[n])r.push(u(o,t[n][0]));o[n]=r}}else if(s.default.isFunction(t[n])){const r=t[n](e[n]);if(!r)throw i.ValidationError.ValidateObjectException(n);o[n]=r}else o[n]=u(e[n],t[n]);return o}t.Validate=function(e,t){return n(this,void 0,void 0,function*(){try{return u(e,t)}catch(e){throw e}})},t.isString=function(e,t=0,o=300){return s.default.isString(e)&&e.length>=t&&e.length<=o?e:null},t.isStringRegex=function(e,t){return s.default.isString(e)&&t.test(e)?e:null},t.isNumber=function(e){return s.default.isNumber(e)?e:null},t.isBoolean=function(e){return s.default.isBoolean(e)?e:null},t.isObjectId=function(e){return c.ObjectId.isValid(e)?new c.ObjectId(e):null},t.isDate=function(e){const t=a(e,"DD-MM-YYYY",!0);return t.isValid()?t.toDate():null},t.isDateTime=function(e){const t=a(e,"DD-MM-YYYY HH:mm:ss",!0);return t.isValid()?t.toDate():null},t.isValid=u},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))(function(r,s){function i(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?r(e.value):new o(function(t){t(e.value)}).then(i,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=o(7),s=o(1);class i{constructor(){}static connect(e,t){return n(this,void 0,void 0,function*(){try{yield r.MongoClient.connect(e,{useNewUrlParser:!0});return e+" - "+t}catch(e){throw e}})}static connectMultitenant(e){return n(this,void 0,void 0,function*(){const t=yield r.MongoClient.connect(e,{useNewUrlParser:!0});return i.dbs[t.db().databaseName]=t.db(),t.db()})}static getDbMultitenant(e){if(e&&this.dbs[e])return this.dbs[e]}}i.dbs={},t.MongoConfig=i,i.connectMultitenant(s.env.mongo.c0).then(e=>console.log("connect c0")).then(e=>i.connectMultitenant(s.env.mongo.c1)).then(e=>console.log("connect c1")).then(e=>i.connectMultitenant(s.env.mongo.c2)).then(e=>console.log("connect c2")).then(e=>i.connectMultitenant(s.env.mongo.c3)).then(e=>console.log("connect c3")).then(e=>i.connectMultitenant(s.env.mongo.c4)).then(e=>console.log("connect c4")).then(e=>i.connectMultitenant(s.env.mongo.c5)).then(e=>console.log("connect c5")).then(e=>i.connectMultitenant(s.env.mongo.c6)).then(e=>console.log("connect c6")).then(e=>i.connectMultitenant(s.env.mongo.common)).then(e=>console.log("connect common")),t.default=i},function(e,t){e.exports=require("bson")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("mongodb")},function(e,t){e.exports=require("moment")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(0),r=o(23);class s{constructor(e,t){this.data=e,this.error=t}static ok(){return new s("ok",null)}static okObject(e){return new s(e,null)}static okCount(e){return new s({message:"ok",numInserted:e},null)}static errorResponse(e){return e instanceof n.AppError?new s(null,e):new s(null,r.SystemError.MessageError(e.message))}}t.AppResponse=s},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))(function(r,s){function i(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?r(e.value):new o(function(t){t(e.value)}).then(i,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0});const r=o(24),s=o(9),i=o(11),a=o(12),c=o(25),u=o(1);t.fromJwt=function(e,t,o){const n=e.header("Authorization"),l=e.method,d=e.baseUrl,h=e.route.path;if(!n)return t.status(400).send(s.AppResponse.errorResponse(r.HeaderError.AuthorizationHeaderError("Authorization")));try{const r=i.verify(n,u.env.privateKey);if("/authentication"===d&&"/refresh_token"===h)return e._id=r.id,e.userName=r.userName,o();const f=r.functions;for(const n of f)if("/"+n._id===d)return"GET"===l&&"/"===h&&-1!==n.methods.indexOf("ra")?(e._id=r.id,e.userName=r.userName,o()):"GET"===l&&"/:id"===h&&-1!==n.methods.indexOf("ro")?(e._id=r.id,e.userName=r.userName,o()):"POST"===l&&"/"===h&&-1!==n.methods.indexOf("c")?(e._id=r.id,e.userName=r.userName,o()):"PUT"===l&&"/:id"===h&&-1!==n.methods.indexOf("u")?(e._id=r.id,e.userName=r.userName,o()):"DELETE"===l&&"/:id"===h&&-1!==n.methods.indexOf("d")?(e._id=r.id,e.userName=r.userName,o()):t.status(400).send(s.AppResponse.errorResponse(c.AuthorizationError.NoHasError(e.originalUrl+" "+e.method)));return t.status(400).send(s.AppResponse.errorResponse(c.AuthorizationError.NoHasError(e.originalUrl+" "+e.method)))}catch(e){return"jwt expired"!==e.message?t.status(400).send(s.AppResponse.errorResponse(e)):t.status(400).send(s.AppResponse.errorResponse(a.AuthenticationError.TokenExpiration()))}},t.tojwt=function(e,t){return n(this,void 0,void 0,function*(){const o={id:e._id,userName:e.userName,functions:t};let n;try{n=yield i.sign(o,u.env.privateKey,{expiresIn:"40000s"})}catch(e){throw e}return n})}},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(0),r=o(2);class s extends n.AppError{constructor(e,t,o){super(s.name,e,[],t,"",o)}static LoginError(e){const t=r.errors.LoginError;return new s(t.message,t.code,e)}static TokenExpiration(){const e=r.errors.TokenExpirationError;return new s(e.message,e.code,"")}static resetPasswordWithoutLocal(){return new s("El email ingresado no es un email local",22,"")}}t.AuthenticationError=s},function(e,t,o){"use strict";var n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)Object.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t.default=e,t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=n(o(14)),i=r(o(15)),a=o(1),c=function(e){const t="string"==typeof e?parseInt(e,10):e;return isNaN(t)?e:t>=0&&t}(process.env.PORT||a.env.port.authentication||3e3);i.default.set("port",c);const u=s.createServer(i.default);u.listen(c),u.on("error",function(e){if("listen"!==e.syscall)throw e;const t="string"==typeof c?"Pipe "+c:"Port "+c;switch(e.code){case"EACCES":console.error(`${t} requires elevated privileges`),process.exit(1);break;case"EADDRINUSE":console.error(`${t} is already in use`),process.exit(1);break;default:throw e}}),u.on("listening",function(){const e=u.address(),t="string"==typeof e?`pipe ${e}`:`port ${e.port}`;console.log(`Server listening on port ${t}`)})},function(e,t){e.exports=require("http")},function(e,t,o){"use strict";var n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)Object.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t.default=e,t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=n(o(16)),i=r(o(17)),a=r(o(6)),c=o(18),u=r(o(4)),l=o(1),d=new c.AuthenticationController;t.default=(new class{constructor(){this.app=a.default(),this.config(),this.routes(),this.initPasspotRoutes(),this.initDatabase()}config(){this.app.use(s.urlencoded({extended:!0})),this.app.use(s.json()),this.app.use(i.default()),this.app.use((e,t,o)=>{t.header("Access-Control-Allow-Origin","http://localhost:4200"),t.header("Access-Control-Allow-Methods","GET, POST, PUT, DELETE, OPTIONS"),t.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization, Access-Control-Allow-Credentials"),t.header("Access-Control-Allow-Credentials","true"),o()})}routes(){this.app.use("/authentication",d.router)}initDatabase(){u.default.connect(l.env.mongo.url,l.env.mongo.db).then(e=>{console.log("Connect to database ",e)})}initPasspotRoutes(){}pruebas(){}}).app},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("cors")},function(e,t,o){"use strict";var n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)Object.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t.default=e,t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=o(6),i=o(19),a=o(22),c=o(3),u=o(9),l=o(10),d=n(o(26)),h=o(27),f=r(o(8)),p=o(1),m=new h.AuthenticationService;t.AuthenticationController=class{constructor(){this.router=s.Router(),this.router.post("/login",this.login),this.router.get("/register/:token",this.register),this.router.post("/confirmEmail",this.confirmEmail),this.router.get("/refresh_token",l.fromJwt,this.refreshToken),this.router.get("/github",this.accessGitHub),this.router.get("/google",this.accessGoogle),this.router.get("/facebook",this.accessFacebook),this.router.get("/reset/:email",this.resetPassword)}refreshToken(e,t){m.renovarToken(e.userName).then(e=>t.status(200).send(e)).catch(e=>{t.status(400).send(u.AppResponse.errorResponse(e))})}login(e,t){c.Validate(e.body,i.LoginDtoRules).then(e=>e).then(e=>m.login(e)).then(e=>t.status(200).send(e)).catch(e=>{t.status(400).send(u.AppResponse.errorResponse(e))})}register(e,t){m.register(e.params.token).then(e=>t.json(e)).catch(e=>t.status(400).json(u.AppResponse.errorResponse(e)))}accessGitHub(e,t){d.get({url:`https://github.com/login/oauth/access_token?client_id=${p.env.oauth.github.clientId}&client_secret=${p.env.oauth.github.secret}&code=${e.query.code}`,headers:{accept:"application/json"},json:!0}).then(e=>d.get({url:"https://api.github.com/user",headers:{Authorization:"token "+e.access_token,"user-agent":"node.js"},json:!0})).then(e=>m.registerAndLogin(e.login,e.email,"github","","",new Date,"",e.avatar_url)).then(e=>t.redirect(p.env.hostFront+"/authentication/login/"+e)).catch(e=>{t.status(400).send(u.AppResponse.errorResponse(e))})}accessGoogle(e,t){d.post("https://www.googleapis.com/oauth2/v4/token",{form:{code:e.query.code,client_id:p.env.oauth.google.clientId,client_secret:p.env.oauth.google.secret,redirect_uri:p.env.oauth.google.redirect_uri,grant_type:"authorization_code"},json:!0}).then(e=>d.get({url:"https://www.googleapis.com/plus/v1/people/me",headers:{Authorization:"Bearer "+e.access_token},json:!0})).then(e=>(console.log(e),e)).then(e=>m.registerAndLogin(e.emails[0].value,e.emails[0].value,"google",e.name.givenName,e.name.familyName,new Date,"",e.image.url.substring(0,e.image.url.length-2)+"160")).then(e=>t.redirect(p.env.hostFront+"/authentication/login/"+e)).catch(e=>{t.status(400).send(u.AppResponse.errorResponse(e))})}accessFacebook(e,t){d.post("https://graph.facebook.com/v3.2/oauth/access_token",{form:{code:e.query.code,client_id:p.env.oauth.facebook.clientId,client_secret:p.env.oauth.facebook.secret,redirect_uri:p.env.oauth.facebook.redirect_uri},json:!0}).then(e=>d.get({url:"https://graph.facebook.com/v3.2/me?fields=id%2Cname%2Caddress%2Cbirthday%2Cemail%2Cgender%2Cfirst_name%2Cpicture.type(large)%7Burl%7D%2Clast_name&access_token="+e.access_token,json:!0})).then(e=>m.registerAndLogin(e.email,e.email,"facebook",e.first_name,e.last_name,f.default(e.birthday,"MM/DD/YYYY").toDate(),e.gender,e.picture.data.url)).then(e=>t.redirect(p.env.hostFront+"/authentication/login/"+e)).catch(e=>{t.status(400).send(u.AppResponse.errorResponse(e))})}resetPassword(e,t){m.resetPassword(e.params.email).then(e=>t.status(200).send(e)).catch(e=>{t.status(400).send(u.AppResponse.errorResponse(e))})}confirmEmail(e,t){c.Validate(e.body,a.RegisterDtoRules).then(e=>e).then(e=>m.enviarConfirmacionEmail(e)).then(e=>t.json(e)).catch(e=>t.status(400).json(u.AppResponse.errorResponse(e)))}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(3);t.LoginDtoRules={user:e=>n.isStringRegex(e,/^(?=.{8,20}$)(?![_.])(?!.*[_.]{2})[a-zA-Z0-9._]+(?<![_.])$/),password:e=>n.isString(e)}},function(e,t){e.exports=require("validate.js")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(0),r=o(2);class s extends n.AppError{constructor(e,t,o){super(s.name,e,[],t,"",o)}static ValidateRequestException(e){const t=r.errors.ValidateRequestError;return new s(t.message+" "+e,t.code,"")}static ValidateObjectException(e){const t=r.errors.ValidateRequestError;return new s(t.message+" "+e,t.code,"")}}t.ValidationError=s},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(3);t.RegisterDtoRules={userName:e=>n.isString(e),password:e=>n.isString(e),email:e=>n.isString(e),firstName:e=>n.isString(e),lastName:e=>n.isString(e),birthDate:e=>n.isString(e),gender:e=>n.isString(e)}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(0),r=o(2);class s extends n.AppError{constructor(e,t,o){super(s.name,e,[],t,"",o)}static MessageError(e){const t=r.errors.SystemError;return new s(t.message+" "+e,t.code,"")}}t.SystemError=s},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(0),r=o(2);class s extends n.AppError{constructor(e,t,o){super(s.name,e,[],t,"",o)}static AuthorizationHeaderError(e){const t=r.errors.HeaderError;return new s(t.message.replace("$1",e),t.code,"")}}t.HeaderError=s},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(0),r=o(2);class s extends n.AppError{constructor(e,t,o){super(s.name,e,[],t,"",o)}static NoHasError(e){const t=r.errors.AuthorizationError;return new s(t.message.replace("$1",e),t.code,"")}}t.AuthorizationError=s},function(e,t){e.exports=require("request-promise-native")},function(e,t,o){"use strict";var n=this&&this.__awaiter||function(e,t,o,n){return new(o||(o=Promise))(function(r,s){function i(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?r(e.value):new o(function(t){t(e.value)}).then(i,a)}c((n=n.apply(e,t||[])).next())})},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=o(12),i=o(5),a=o(28),c=o(10),u=o(29),l=o(11),d=o(30),h=o(1),f=o(31),p=r(o(4)).default.getDbMultitenant("common");t.AuthenticationService=class{constructor(){this.dao=new f.AuthenticationDao}login(e){return n(this,void 0,void 0,function*(){let t,o;return this.dao.findByUserNameAndServerResource(p,{id:e.user,serverResource:"local"}).then(t=>d.compare(e.password,t.password).then(o=>{if(o)return t;throw s.AuthenticationError.LoginError(e.user)})).then(e=>(e.password=void 0,e.enabled=void 0,e.roles=void 0,e.functions=void 0,e.audit=void 0,t=e,this.dao.getAllFunctions(p,e.userName))).then(e=>(o=e,c.tojwt(t,e))).then(e=>({jwt:e,functions:o,account:t}))})}register(e){return n(this,void 0,void 0,function*(){const t=l.verify(e,h.env.privateKeyToConfimrEmail);return d.hash(t.password,5).then(e=>({password:e,userName:{id:t.userName,serverResource:"local"},user:{gender:t.gender,lastName:t.lastName,firstName:t.firstName,birthDate:t.birthDate},_id:new i.ObjectId,email:t.email,enabled:!0,functions:[],roles:["user"],audit:new a.AuditModel,db:"c0"})).then(e=>this.dao.insert(p,e)).then(e=>this.login({user:e.userName.id,password:e.password}))})}enviarConfirmacionEmail(e){return n(this,void 0,void 0,function*(){const t=l.sign(e,h.env.privateKeyToConfimrEmail,{expiresIn:"3600s"}),o=u.createTransport({service:h.env.email.server,host:h.env.email.host,auth:{user:h.env.email.user,pass:h.env.email.password}});return new Promise((n,r)=>{o.sendMail({from:h.env.email.user,to:e.email,subject:"Confirmar Email",html:'<p>Pincha<a href="'+h.env.hostFront+"/authentication/register/"+t+'"> a qui </a> para confirmar tu email</p>'},(e,t)=>{e?r({message:e}):n({message:t})})})})}resetPassword(e){return n(this,void 0,void 0,function*(){let t="";return this.dao.findByEmail(p,e).then(t=>{if("local"!==t.userName.serverResource)throw s.AuthenticationError.resetPasswordWithoutLocal();return l.sign({email:e,id:t._id,mensaje:"no me hakees ps y si intentalo ps muajajjajaj"},h.env.privateKey,{expiresIn:"3600s"})}).then(e=>(t=e,e)).then(e=>u.createTransport({service:h.env.email.server,host:h.env.email.host,auth:{user:h.env.email.user,pass:h.env.email.password}})).then(o=>new Promise((n,r)=>{o.sendMail({from:h.env.email.user,to:e,subject:"Reiniciar Password",html:'<p>Pincha<a href="'+h.env.hostFront+"/authentication/reset-password/"+t+'"> a qui </a> para reiniciar tu password</p>'},(e,t)=>{e?r({message:e}):n({message:t})})}))})}renovarToken(e){return n(this,void 0,void 0,function*(){let t,o;return this.dao.findByUserNameAndServerResource(p,e).then(e=>(e.password=void 0,e.enabled=void 0,e.roles=void 0,e.functions=void 0,e.audit=void 0,t=e,this.dao.getAllFunctions(p,e.userName))).then(e=>(o=e,c.tojwt(t,e))).then(e=>({jwt:e,functions:o,account:t}))})}registerAndLogin(e,t,o="local",r="",s="",u=new Date,l="",d=null){return n(this,void 0,void 0,function*(){let n={_id:new i.ObjectId,password:"",userName:{id:e,serverResource:o},user:{gender:l,lastName:s,firstName:r,birthDate:u},email:t,enabled:!0,functions:[],roles:["user"],audit:new a.AuditModel,photo:d};return this.dao.findByUserNameAndServerResource(p,n.userName).then(e=>e||this.dao.insert(p,n)).then(e=>(e.password=void 0,e.enabled=void 0,e.roles=void 0,e.functions=void 0,e.audit=void 0,n=e,e)).then(e=>this.dao.getAllFunctions(p,e.userName)).then(e=>c.tojwt(n,e))})}github(e){return n(this,void 0,void 0,function*(){let t={_id:new i.ObjectId,password:"",userName:{id:e,serverResource:"github"},user:{gender:"",lastName:"",firstName:"",birthDate:new Date},email:"",enabled:!0,functions:[],roles:["user"],audit:new a.AuditModel};return this.dao.findByUserNameAndServerResource(p,t.userName).then(e=>e||this.dao.insert(p,t)).then(e=>(e.password=void 0,e.enabled=void 0,e.roles=void 0,e.functions=void 0,e.audit=void 0,t=e,e)).then(e=>this.dao.getAllFunctions(p,e.userName)).then(e=>c.tojwt(t,e))})}google(e,t,o){return n(this,void 0,void 0,function*(){let n={_id:new i.ObjectId,password:"",userName:{id:e,serverResource:"google"},user:{gender:"",lastName:t,firstName:o,birthDate:new Date},email:"",enabled:!0,functions:[],roles:["user"],audit:new a.AuditModel};return this.dao.findByUserNameAndServerResource(p,n.userName).then(e=>e||this.dao.insert(p,n)).then(e=>(e.password=void 0,e.enabled=void 0,e.roles=void 0,e.functions=void 0,e.audit=void 0,n=e,e)).then(e=>this.dao.getAllFunctions(p,e.userName)).then(e=>c.tojwt(n,e))})}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(5);class r{constructor(){this.createdLocalDate=new Date,this.modifiedLocalDate=new Date,this.modifiedBy=new n.ObjectID,this.createdBy=new n.ObjectID}static newAuditStatic(e){const t=new r;return t.newAudit(e),t}newAudit(e){this.modifiedBy=new n.ObjectId(e),this.createdBy=new n.ObjectId(e),this.modifiedLocalDate=new Date,this.createdLocalDate=new Date}actAudit(e){this.modifiedBy=new n.ObjectId(e),this.modifiedLocalDate=new Date}}t.AuditModel=r},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("bcrypt")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(32),r=o(33);t.AuthenticationDao=class extends n.BaseMongoImpDao{constructor(){super("account")}findByUserNameAndServerResource(e,t){return e.collection(this.collection).findOne({userName:t})}findByEmail(e,t){return e.collection(this.collection).findOne({email:t}).then(e=>{if(e)return e;throw r.ObjectNotFoundError.UserNotFoundException(t)})}getAllFunctions(e,t){return e.collection(this.collection).aggregate([{$match:{userName:t}},{$unwind:{path:"$functions",preserveNullAndEmptyArrays:!0}},{$lookup:{from:"function",as:"functions2",localField:"functions.id",foreignField:"_id"}},{$unwind:{path:"$functions2",preserveNullAndEmptyArrays:!0}},{$project:{roles:1,"f.n":"$functions.id","f.m":{$setIntersection:["$functions.methods","$functions2.methods"]}}},{$group:{_id:"$_id",roles:{$first:"$roles"},func:{$push:"$f"}}},{$lookup:{from:"role",as:"roles",localField:"roles",foreignField:"name"}},{$unwind:{path:"$roles",preserveNullAndEmptyArrays:!0}},{$unwind:{path:"$roles.functions",preserveNullAndEmptyArrays:!0}},{$project:{_id:1,func:1,f:"$roles.functions.id",n:"$roles.functions.methodsNegates"}},{$lookup:{from:"function",as:"f",localField:"f",foreignField:"_id"}},{$unwind:{path:"$f",preserveNullAndEmptyArrays:!0}},{$project:{func:1,"func2.n":"$f._id","func2.m":{$setDifference:["$f.methods","$n"]}}},{$group:{_id:"$_id",func:{$first:"$func"},func2:{$push:"$func2"}}},{$project:{f:{$concatArrays:["$func","$func2"]}}},{$unwind:"$f"},{$unwind:"$f.m"},{$group:{_id:"$f.n",methods:{$addToSet:"$f.m"}}}]).toArray()}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(7);t.BaseMongoImpDao=class{constructor(e){this.collection=e}count(e){return e.collection(this.collection).countDocuments()}findAll(e){return e.collection(this.collection).find().map(e=>(e.audit=void 0,e)).toArray()}findById(e,t){return e.collection(this.collection).findOne({_id:t})}insert(e,t){return e.collection(this.collection).insertOne(t).then(e=>e.ops[0])}removeById(e,t){return e.collection(this.collection).deleteOne({_id:t}).then(e=>e.deletedCount)}update(e,t){const o=t._id;return delete t._id,e.collection(this.collection).updateOne({_id:o},{$set:t}).then(e=>t)}existsById(e,t){return e.collection(this.collection).findOne({_id:new n.ObjectId(t)}).then(e=>!!e)}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(0),r=o(2);class s extends n.AppError{constructor(e="El Objeto no Existe",t=7e4,o=""){super(s.name,e,[],t,"",o)}static UserNotFoundException(e){const t=r.errors.UserNotFoundError;return new s(t.message.replace("$name",e),t.code,e)}}t.ObjectNotFoundError=s}]);